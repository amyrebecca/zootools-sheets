<script type="text/javascript">
var columnDefs;
var $ = function(sel){ return document.querySelector(sel); };
var enable = function(node){ node.removeAttribute('disabled'); }
var disable = function(node){ node.setAttribute('disabled', true); }

function showStatus(msg, classId) {
  var status = document.querySelectorAll('div[data-ui="status"]');
  var icon = '';
  
  if (msg !== '' && classId === 'error') {
    icon = '<i class="fa fa-exclamation-circle" aria-hidden="true"></i>';
  } else if (msg !== '') {
    icon = '<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>';  
  } else {
    icon = '';
  }
  
  for (var i = 0; i < status.length; i++) {
    status[i].className = ""
    status[i].innerHTML = icon + " " + msg;
    if (classId) {
      status[i].classList.add(classId);
    }
  }
}

function failureHandler(err) {
  console.error(err);
  showStatus('Something went wrong: ' + err, 'error');
}

  // use async call to determine initial state of dropdown lists
  // from contents of chart cells
  

  // Setup map visualization via Charts API
  google.load('visualization', '1.0', { 'packages': ['map'] });
  google.setOnLoadCallback(getGoogleMap);

function getVariables() {
  showStatus('Getting variables...');
  google.script.run
    .withSuccessHandler(function(response){
      columnDefs = response;
    
      // Handle if user is not on a sheet with no data
      if (response.length === 0) {
        showStatus('No variables to choose from.', 'error');
        disable($('#latitude'));
        disable($('#longitude'));
        disable($('#updateBtn'));
      } else {
        enable($('#latitude'));
        enable($('#longitude'));
        enable($('#updateBtn'));
        showStatus('');
      }
      
      addVariableOptions();
    })
    .withFailureHandler(failureHandler)
    .clientGetColumnVariables();
}

getVariables();

function addVariableOptions() {
  var options = '';
  var selects = document.querySelectorAll('select[data-select="variable"]');
  var sortedVariableDefs = columnDefs.concat().sort(function(a,b) { return a - b; });

  sortedVariableDefs.forEach(function(variable) {
    var newOption = '<option>' + variable + '</option>';
    options += newOption;
  });
  
  for (var i = 0; i < selects.length; i++) {
    selects[i].innerHTML = options;
  }
}

  function getCoordinates(){
    var latitude = $('#latitude').value;
    var longitude = $('#longitude').value;
    
    showStatus('Getting map...');
    
    google.script.run
      .withSuccessHandler(
        function(response) {
          getGoogleMap(null, response);
          showStatus('');
      })
      .withFailureHandler(failureHandler)
      .clientGetCoordinates(latitude, longitude)
  }

  function getGoogleMap(event, coordinates){
    var load = [];
    if (coordinates) {
      load = coordinates;
    } else {
      load = [['Lat', 'Long', 'Name'], [41.8339042, -88.0123485, 'Placeholder']];
    }
    var data = google.visualization.arrayToDataTable(load);
    var map = new google.visualization.Map($('#map-container'));
    
    map.draw(data, {showTip: true});  
  }
</script>