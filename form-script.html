<script>
  var autocomplete = {
    institution: null,
    location: null
  };
  
  // Selector function
  var $ = function(sel){ return document.querySelector(sel); };
  $('#form-submit').addEventListener('click', onSubmitClick);
  
  /**
   * Run initializations on dialog load.
   */
  function initAutocomplete() {
    // Create the autocomplete object, restricting the search to geographical
    // location types.
    autocomplete.institution = new google.maps.places.SearchBox(
      /** @type {!HTMLInputElement} */($("#institution")),
      {types: ['geocode']});
    autocomplete.location = new google.maps.places.SearchBox(
      /** @type {!HTMLInputElement} */($("#location")),
      {types: ['geocode']});
  }
  
  // Add onfocus event to inputs after document is loaded
  document.addEventListener("DOMContentLoaded", function(event) { 
    var locationInputs = document.querySelectorAll('input[data-input="location"]');
    
    for (var i = 0; i < locationInputs.length; i++) {
      locationInputs[i].addEventListener('focus', geolocate);
    } 
  });
  
  function geolocate(event) {
    var el = event.target;
    
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        var geolocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        var circle = new google.maps.Circle({
          center: geolocation,
          radius: position.coords.accuracy
        });
        autocomplete[el.id].setBounds(circle.getBounds());
        // Remove onfocus listener to keep Firefox from continuously firing it. 
        el.removeEventListener('focus', geolocate);
      }, failureHandler, {timeout: 10000});
    }
  }
  /**
   * Adds form submission to the sheet
   */
  function onSubmitClick() {
    this.disabled = true;
    // Gather any information that needs to be sent to the server here.
    var institution = $('#institution').value;
    var institutionPlace = autocomplete.institution.getPlaces();
    var institutionAddress = institutionPlace[0].formatted_address || institution; // Send something to the geocoder in case the getPlaces() call fails
    var location = $('#location').value;
    var locationPlace = autocomplete.location.getPlaces();
    var locationAddress = locationPlace[0].formatted_address || location; // Send something to the geocoder in case the getPlaces() call fails

    showStatus('Working...');
    // Send the value to the server and handle the response.
    google.script.run
      .withSuccessHandler(successHandler)
      .withFailureHandler(failureHandler)
      .withUserObject(this)
      .clientAddFormSubmission(institution, institutionAddress, location, locationAddress);
  }
  
  function successHandler(){
    google.script.host.close()
  }
  
  function failureHandler(err) {
    console.error(err);
    showStatus('Something went wrong: ' + err, 'error');
  }

  function showStatus(msg, classId) {
    var status = $('#status'); 
    status.className = ""
    status.innerHTML = msg;
    if (classId) {
      status.classList.add(classId);
    }
  }
</script>


