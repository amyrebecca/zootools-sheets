<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css" />
    <style type="text/css">
      body{ margin: 1em; }
      .form-group{ margin-bottom: 2em; margin-top: 2em; }
      h6{ line-height: 100%; margin-top: 1.5em; margin-bottom: 0.5em; }
      .collapse .extended{ display: none; }
      .extended{ display: block; }
      h6::after{ content: '\2013'; float: right; font-weight: bold; margin-right: 0.5em; }
      .collapse h6::after{ content: '+'; float: right; font-weight: bold; margin-right: 0.5em; }
    </style>
    <script>
      var xInit = null;
      var yInit = null;
      var columnDefs;

      // use async call to determine initial state of dropdown lists
      // from contents of chart cells
      google.script.run.withSuccessHandler(function(res){
        document.getElementById('xVar').value = xInit = res[0];
        document.getElementById('xVar').removeAttribute('disabled');
        document.getElementById('yVar').value = yInit = res[1];
        document.getElementById('yVar').removeAttribute('disabled');
      }).clientGetNames();
      
      google.script.run.withSuccessHandler(function(res){
        var refs = {};
        for(var idx in res){
          refs[res[idx].name] = res[idx];
        }
        columnDefs = refs;
      }).clientGetVariables();

      // every time the user changes a dropdown, we check to see if they should be
      // able to submit (plotting X vs. X just makes no sense)
      function updateSelection(fromSelect){

        var updateBtn = document.getElementById('updateBtn');
        var resetBtn = document.getElementById('resetBtn');
        var xSelect = document.getElementById('xVar').value;
        var ySelect = document.getElementById('yVar').value;

        if(fromSelect){
          xDefaults = columnDefs[xSelect];
          yDefaults = columnDefs[ySelect];
        }
        
        if(fromSelect == 'X')
        {
          if(xDefaults.invert){ document.getElementById('invertX').setAttribute('checked', true); }
          else{ document.getElementById('invertX').removeAttribute('checked'); }
          
          if(xDefaults.log){ document.getElementById('logX').setAttribute('checked', true); }
          else{ document.getElementById('logX').removeAttribute('checked'); }
        }

        if(fromSelect == 'Y')
        {
          if(yDefaults.invert){ document.getElementById('invertY').setAttribute('checked', true); }
          else{ document.getElementById('invertY').removeAttribute('checked'); }
          
          if(yDefaults.log){ document.getElementById('logY').setAttribute('checked', true); }
          else{ document.getElementById('logY').removeAttribute('checked'); }
        }

        resetBtn.removeAttribute('disabled');
        updateBtn.removeAttribute('disabled');
      }

      // reset the selected variables to the state when the chart loaded
      function resetSelection(){
        document.getElementById('xVar').value = xInit;
        document.getElementById('yVar').value = yInit;
        updateSelection();
      }

      // update the chart from the client's selected variables
      function clientChangeSelection(){
        var xSelect = document.getElementById('xVar').value;
        var ySelect = document.getElementById('yVar').value;
        
        var xOpts = { 
          invert: document.getElementById('invertX').checked, 
          log: document.getElementById('logX').checked,
          range: (document.getElementById('xScaleDefault').checked ? 
            null : 
            { 
              min: document.getElementById('xMin').value, 
              max: document.getElementById('xMax').value 
            })
        };
        
        var yOpts = { 
          invert: document.getElementById('invertY').checked, 
          log: document.getElementById('logY').checked,
          range: (document.getElementById('yScaleDefault').checked ? 
            null : 
            { 
              min: document.getElementById('yMin').value, 
              max: document.getElementById('yMax').value 
            })
        };
        
        google.script.run.clientSetNames(xSelect, ySelect, xOpts, yOpts);
      }

      function removeClass(e,c) {e.className = e.className.replace( new RegExp('(?:^|\\s)'+c+'(?!\\S)') ,''); }
      function addClass(e,c){ e.className = [e.className, c].join(' '); }

      var rangeEnable = { x: false, y: false }
      function toggleRange(varName){
        var textSel = ['#', varName, 'Range', ' input[type=text]'].join('');
        Array.prototype.slice.call(document.querySelectorAll(textSel),0).map(function(e,i){ e.removeAttribute('disabled'); });
        if(rangeEnable[varName]){
          Array.prototype.slice.call(document.querySelectorAll(textSel),0).map(function(e,i){ e.setAttribute('disabled','disabled'); });
        }
        
        rangeEnable[varName] = !rangeEnable[varName];
        updateSelection();
      }

      var expand = { x: false, y: false };

      function toggleVar(varName){
        var elemId = varName + 'Def';
        
        removeClass(document.getElementById(elemId), 'collapse');
        if(expand[varName]){
          addClass(document.getElementById(elemId), 'collapse');
        }

        expand[varName] = !expand[varName];
      }
      
    </script>
  </head>
  <body>
    <div class="block">
      <h1>Scatter Plot Helper</h1>
    </div>
    <div class="block">
      You may change the independent (X) and dependent (Y) variables below, then press Update to redraw the plot.
    </div>
    <div class="block">
      <hr/>
    </div>
    <div class="block">
      <? columnDefs = clientGetVariables(); ?>
      <div class="block form-group collapse" id="xDef">
        <h6 style="cursor: pointer" onclick="toggleVar('x')">X Variable</h6>
        <select id="xVar" style="width: 100%;" oninput="updateSelection('X')" disabled>
          <? for(var i = 0; i < columnDefs.length; i++) { ?>
            <option><?= columnDefs[i].name ?></option>
          <? } ?>
        </select>
        <div class="extended">
          <p><strong>Axis</strong></p>
          <div style="float: right; width: 50%;"><input type="checkbox" id="logX" onclick="updateSelection()"><label for="logX">Logarithmic</label></div>
          <div><input type="checkbox" id="invertX" onclick="updateSelection()"/><label for="invertX">Invert</label></div>
        </div>
        <div class="extended" id="xRange">
          <p><strong>Range</strong></p>
          <p><input type="radio" id="xScaleDefault" name="xScale" onclick="toggleRange('x')" checked><label for="xScaleDefault">Auto</label></p>
          <p><input type="radio" id="xScaleSpecific" name="xScale" onclick="toggleRange('x')"><label for="xScaleSpecific">Specified</label></p>
          <div style="text-indent: 1.5em;">
            <div style="text-align: justify"><input type="text" pattern="\d*" id="xMin" style="width: 30%; " disabled/>&nbsp; to &nbsp;<input type="text" pattern="\d*" id="xMax" style="width: 30%; " disabled /></div>
          </div>
        </div>
      </div>
      <div class="block form-group collapse" id="yDef">
        <h6 style="cursor: pointer" onclick="toggleVar('y')">Y Variable</h6>
        <select id="yVar" style="width: 100%;" oninput="updateSelection('Y')" disabled>
          <? for(var i = 0; i < columnDefs.length; i++) { ?>
            <option><?= columnDefs[i].name ?></option>
          <? } ?>
        </select>
        <div class="extended">
          <p><strong>Axis</strong></p>
          <div style="float: right; width: 50%;"><input type="checkbox" id="logY" onclick="updateSelection()"><label for="logY">Logarithmic</label></div>
          <div><input type="checkbox" id="invertY" onclick="updateSelection()"/><label for="invertY">Invert</label></div>
        </div>
        <div class="extended" id="yRange">
          <p><strong>Range</strong></p>
          <p><input type="radio" id="yScaleDefault" name="yScale" onclick="toggleRange('y')" checked><label for="yScaleDefault">Auto</label></p>
          <p><input type="radio" id="yScaleSpecific" name="yScale" onclick="toggleRange('y')"><label for="yScaleSpecific">Specified</label></p>
          <div style="text-indent: 1.5em;">
            <div style="text-align: justify"><input type="text" pattern="\d*" id="yMin" style="width: 30%; " disabled />&nbsp; to &nbsp;<input type="text" pattern="\d*" id="yMax" style="width: 30%; " disabled /></div>
          </div>
        </div>
      </div>
    </div>
    <div class="block">
      <hr/>
    </div>
    <div class="block form-group" style="text-align: center; ">
      <button id="updateBtn" class="action" onclick="clientChangeSelection()" disabled>Update</button>
      <button id="resetBtn" onclick="resetSelection()" disabled>Reset</button>
      <button onclick="google.script.host.close()">Close</button>
    </div>
  </body>
</html>



