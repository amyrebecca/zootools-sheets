<script type="text/javascript">

var xInit = null;
var yInit = null;
var columnDefs;

// use async call to determine initial state of dropdown lists
// from contents of chart cells
google.script.run.withSuccessHandler(function(res){
	document.getElementById('xVar').value = xInit = res.xVal;
	document.getElementById('xVar').removeAttribute('disabled');
	document.getElementById('yVar').value = yInit = res.yVal;
	document.getElementById('yVar').removeAttribute('disabled');
}).clientGetConfiguration();

google.script.run.withSuccessHandler(function(res){
	var refs = {};
	for(var idx in res){
		refs[res[idx].name] = res[idx];
	}
	columnDefs = refs;
}).clientGetVariables();

// every time the user changes a dropdown, we check to see if they should be
// able to submit (plotting X vs. X just makes no sense)
function updateSelection(fromSelect){

	var updateBtn = document.getElementById('updateBtn');
	var resetBtn = document.getElementById('resetBtn');
	var xSelect = document.getElementById('xVar').value;
	var ySelect = document.getElementById('yVar').value;

	if(fromSelect){
		xDefaults = columnDefs[xSelect];
		yDefaults = columnDefs[ySelect];
	}

	if(fromSelect == 'X')
	{
		if(xDefaults.invert){ document.getElementById('invertX').setAttribute('checked', true); }
		else{ document.getElementById('invertX').removeAttribute('checked'); }

		if(xDefaults.log){ document.getElementById('logX').setAttribute('checked', true); }
		else{ document.getElementById('logX').removeAttribute('checked'); }
	}

	if(fromSelect == 'Y')
	{
		if(yDefaults.invert){ document.getElementById('invertY').setAttribute('checked', true); }
		else{ document.getElementById('invertY').removeAttribute('checked'); }

		if(yDefaults.log){ document.getElementById('logY').setAttribute('checked', true); }
		else{ document.getElementById('logY').removeAttribute('checked'); }
	}

	resetBtn.removeAttribute('disabled');
	updateBtn.removeAttribute('disabled');
}

// reset the selected variables to the state when the chart loaded
function resetSelection(){
	document.getElementById('xVar').value = xInit;
	document.getElementById('yVar').value = yInit;
	updateSelection();
}

// update the chart from the client's selected variables
function clientChangeSelection(){
	var xSelect = document.getElementById('xVar').value;
	var ySelect = document.getElementById('yVar').value;

	var xOpts = { 
		invert: document.getElementById('invertX').checked, 
		log: document.getElementById('logX').checked,
		range: (document.getElementById('xScaleDefault').checked ? 
			null : 
			{ 
				min: document.getElementById('xMin').value, 
				max: document.getElementById('xMax').value 
			})
	};

	var yOpts = { 
		invert: document.getElementById('invertY').checked, 
		log: document.getElementById('logY').checked,
		range: (document.getElementById('yScaleDefault').checked ? 
			null : 
			{ 
				min: document.getElementById('yMin').value, 
				max: document.getElementById('yMax').value 
			})
	};

	var newConfig = {
		xVal: document.getElementById('xVar').value,
		yVal: document.getElementById('yVar').value,
		xOpts: xOpts,
		yOpts, yOpts
	};

//google.script.run.clientSetNames(xSelect, ySelect, xOpts, yOpts);
google.script.run.clientSetConfiguration(newConfig);
}

function removeClass(e,c) {e.className = e.className.replace( new RegExp('(?:^|\\s)'+c+'(?!\\S)') ,''); }
function addClass(e,c){ e.className = [e.className, c].join(' '); }

var rangeEnable = { x: false, y: false }
function toggleRange(varName){
	var textSel = ['#', varName, 'Range', ' input[type=text]'].join('');
	Array.prototype.slice.call(document.querySelectorAll(textSel),0).map(function(e,i){ e.removeAttribute('disabled'); });
	if(rangeEnable[varName]){
		Array.prototype.slice.call(document.querySelectorAll(textSel),0).map(function(e,i){ e.setAttribute('disabled','disabled'); });
	}

	rangeEnable[varName] = !rangeEnable[varName];
	updateSelection();
}

var expand = { x: false, y: false };

function toggleVar(varName){
	var elemId = varName + 'Def';

	removeClass(document.getElementById(elemId), 'collapse');
	if(expand[varName]){
		addClass(document.getElementById(elemId), 'collapse');
	}

	expand[varName] = !expand[varName];
}

</script>