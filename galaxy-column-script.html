<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/2.4.2/math.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script type="text/javascript">
// Setup and utility functions
var columnDefs, chartWrapper, data;
var config = null;
var $ = function(sel){ return document.querySelector(sel); };
var clean = function(node){ return !!node.value ? parseFloat(node.value) : null; };
var enable = function(node){ node.removeAttribute('disabled'); }
var disable = function(node){ node.setAttribute('disabled', true); }

function showStatus(msg, classId) {
  var status = document.querySelectorAll('div[data-ui="status"]');
  var icon = '';
  
  if (msg !== '' && classId === 'error') {
    icon = '<i class="fa fa-exclamation-circle" aria-hidden="true"></i>';
  } else if (msg !== '') {
    icon = '<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>';  
  } else {
    icon = '';
  }
  
  for (var i = 0; i < status.length; i++) {
    status[i].className = ""
    status[i].innerHTML = icon + " " + msg;
    if (classId) {
      status[i].classList.add(classId);
    }
  }
}

function failureHandler(err) {
  console.error(err);
  showStatus('Something went wrong: ' + err, 'error');
}

// Load the Google Visualization library
google.load("visualization", "1", {packages:["corechart"]});
google.setOnLoadCallback(loadChart);

// Instantiate the chart
function loadChart() {
  chartWrapper = new google.visualization.ChartWrapper();
} 

// use async call to determine initial state of dropdown lists
// from contents of chart cells
function getRowIds() {
  showStatus('Getting galaxy ids...');
  google.script.run
    .withSuccessHandler(function(res){
      var refs = {};
      for(var idx in res) {
        refs[res[idx].name] = res[idx];
      }
      columnDefs = refs;
    
      // Handle if user is not on a sheet with no data
      if (res.length === 0) {
        showStatus('No galaxy ids to choose from.', 'error');
        disable($('#xVar'));
        disable($('#updateBtn'));
      } else {
        enable($('#xVar'));
        enable($('#updateBtn'));
        showStatus('');
      }
      
      if (res !== columnDefs) { addVariableOptions() }
    })
    .withFailureHandler(failureHandler)
    .clientGetRowIds();
}

getRowIds();

function addVariableOptions() {
  var options = '';
  var selects = document.querySelectorAll('select[data-select="variable"]');
  
  for (var key in columnDefs) {
    var newOption = '<option>' + columnDefs[key].name + '</option>';
    options += newOption;
  }
  
  for (var i = 0; i < selects.length; i++) {
    selects[i].innerHTML = options;
  }
}

function applyState(config){
  $('#xVar').value = config.x.variable;
}

function extractState(){
  var res = {
    x: {
      variable: $('#xVar').value
    },
  };

  return res;
}

// every time the user changes a dropdown, we check to see if they should be
// able to submit (plotting X vs. X just makes no sense)
function updateSelection(src){
  var state = extractState();
    
  applyState(state);
  updateBtn.removeAttribute('disabled');
}

function resetState() {  
  var state = extractState();
  applyState(state);
}

// update the chart from the client's selected variables
function clientChangeSelection(){
    var xVar = $('#xVar').value;
   
    showStatus('Drawing Column Chart...');
    
    google.script.run
      .withSuccessHandler(function(res) {
        showStatus('');
        previewChart(res);
      })
      .withFailureHandler(failureHandler)
      .clientGetRowValues(xVar);
}

// Use response from sheet to setup data in format expected by Charts API for scatter plots
function setupDataTable(spreadsheetValues) {
  var table = [['Galaxy Type', 'Votes']];
  
  for (i = 0; i < spreadsheetValues.headers[0].length; i++){
    table.push([spreadsheetValues.headers[0][i], spreadsheetValues.values[0][i]]);
  }

  return table;
}

function previewChart(spreadsheetValues) {
  data = setupDataTable(spreadsheetValues);
  var dataTable = google.visualization.arrayToDataTable(data);
  var options = {
    legend: { position: 'none' },
    bar: { groupWidth: '100%' },
    vAxis: { title: "Count of Votes" }
  };
  var sendToSheetBtn = $('#sendToSheetBtn');
  
  disable(sendToSheetBtn); 
  
  chartWrapper.setChartType('ColumnChart');
  chartWrapper.setDataTable(dataTable);
  chartWrapper.setOptions(options);
  chartWrapper.setContainerId('chart-preview');

  // Add event listener
  google.visualization.events.addListener(chartWrapper, 'ready', function(){
    enable(sendToSheetBtn);
  });
  
  // Draw the chart
  chartWrapper.draw()
}

function clientSendToSheet() {
  var state = extractState();
  showStatus('Sending...');
  google.script.run
    .withSuccessHandler(function(res){
      showStatus('');
      $('#chart-preview').innerHTML = '';
      chartWrapper = new google.visualization.ChartWrapper();
      resetState();
      getRowIds();
      disable($('#sendToSheetBtn'));
    })
    .withFailureHandler(failureHandler)
    .clientAddChart(state, data, 'column');
}
</script>

